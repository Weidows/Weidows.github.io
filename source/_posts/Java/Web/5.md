---
title: ğŸ¥¼JavaWeb~(ä¼)æ¶æ„,filter,listener,demo.
password: ""
tags:
  - JavaWeb
  - Java
  - æœåŠ¡å™¨
  - ç¬”è®°
  - Servlet
  - Filter
  - æ¶æ„
date: 2021-04-08 23:43:55
cover: https://cdn.jsdelivr.net/gh/Weidows/Images/post/20210322091847.png
top_img:
---

<!--
 * @?: *********************************************************************
 * @Author: Weidows
 * @LastEditors: Weidows
 * @LastEditTime: 2021-05-01 00:27:57
 * @FilePath: \Weidowsd:\Game\Github\Blog-private\source\_posts\Java\Web\5.md
 * @Description:
 * @!: *********************************************************************
-->

- [ç¬”è®°ä»£ç ](#ç¬”è®°ä»£ç )
- [MVC æ¶æ„](#mvc-æ¶æ„)
- [ä¸­é—´å±‚å·¥å…·](#ä¸­é—´å±‚å·¥å…·)
  - [Filter è¿‡æ»¤å™¨](#filter-è¿‡æ»¤å™¨)
    - [ä»‹ç»](#ä»‹ç»)
    - [å¯¼å…¥ä¾èµ–](#å¯¼å…¥ä¾èµ–)
    - [filter ä¾‹å­](#filter-ä¾‹å­)
  - [ç›‘å¬å™¨](#ç›‘å¬å™¨)
  - [GUI ç¼–ç¨‹ä¾‹å­](#gui-ç¼–ç¨‹ä¾‹å­)
  - [ç™»å½•éªŒè¯ demo](#ç™»å½•éªŒè¯-demo)

## [ç¬”è®°ä»£ç ](https://github.com/Weidows/Java/tree/master/JavaWeb)

<a>![åˆ†å‰²çº¿](https://cdn.jsdelivr.net/gh/Weidows/Images/img/divider.png)</a>

## MVC æ¶æ„

> Model æ¨¡å‹ view è§†å›¾ Controller æ§åˆ¶ ä¸‰æ–¹åˆ†ç¦»çš„æ¶æ„

- ä¹‹å‰çš„æ¶æ„:

  - Servlet ç›´æ¥è¿›è¡Œ CRUD æ“ä½œ,ç¨‹åºæ¯”è¾ƒè‡ƒè‚¿,ä¸åˆ©äºç»´æŠ¤

  > <img src="https://cdn.jsdelivr.net/gh/Weidows/Images/post/20210409093031.png" alt="20210409093031" />

  ***

- äºæ˜¯,ä¸ºäº†è§£å†³è¿™ç§ä¸ä¾¿åˆ©æ€§,å†åŠ ä¸€å±‚! (æ²¡æœ‰ä»€ä¹ˆæ˜¯åŠ ä¸€å±‚è§£å†³ä¸äº†çš„)

  > <img src="https://cdn.jsdelivr.net/gh/Weidows/Images/post/20210409093440.png" alt="20210409093440" />

  ***

- å„éƒ¨åˆ†çš„èŒè´£:

  - Model

    - ä¸šåŠ¡å¤„ç† ï¼šä¸šåŠ¡é€»è¾‘ï¼ˆServiceï¼‰

    - æ•°æ®æŒä¹…å±‚ï¼šCRUD ï¼ˆDao - æ•°æ®æŒä¹…åŒ–å¯¹è±¡ï¼‰

  - View

    - å±•ç¤ºæ•°æ®

    - æä¾›é“¾æ¥å‘èµ· Servlet è¯·æ±‚ ï¼ˆaï¼Œformï¼Œimgâ€¦ï¼‰

  - Controller ï¼ˆServletï¼‰

    - æ¥æ”¶ç”¨æˆ·çš„è¯·æ±‚ ï¼šï¼ˆreqï¼šè¯·æ±‚å‚æ•°ã€Session ä¿¡æ¯â€¦.ï¼‰

    - äº¤ç»™ä¸šåŠ¡å±‚å¤„ç†å¯¹åº”çš„ä»£ç 

    - æ§åˆ¶è§†å›¾çš„è·³è½¬ (è½¬å‘/é‡å®šå‘)

  ***

- ä¸€æ¡æµç¨‹:

  View å±‚ç‚¹å‡»ç™»å½• --> æ¥æ”¶ç”¨æˆ·çš„ç™»å½•è¯·æ±‚ --> å¤„ç†ç”¨æˆ·çš„è¯·æ±‚ï¼ˆè·å–ç”¨æˆ·ç™»å½•çš„å‚æ•°ï¼Œusernameï¼Œpasswordï¼‰--> äº¤ç»™ä¸šåŠ¡å±‚å¤„ç†ç™»å½•ä¸šåŠ¡ï¼ˆåˆ¤æ–­ç”¨æˆ·åå¯†ç æ˜¯å¦æ­£ç¡®ï¼šæ“ä½œäº‹åŠ¡ï¼‰--> Dao å±‚æŸ¥è¯¢ç”¨æˆ·åå’Œå¯†ç æ˜¯å¦æ­£ç¡® --> æ•°æ®åº“

  é¡ºåˆ©æŸ¥è¯¢åˆ°æ•°æ®ä¹‹åå°±æ˜¯åè¿‡æ¥å†è¿›è¡Œæ•°æ®ä¼ é€’

<a>![åˆ†å‰²çº¿](https://cdn.jsdelivr.net/gh/Weidows/Images/img/divider.png)</a>

## ä¸­é—´å±‚å·¥å…·

- å¸¸è§çš„æœ‰`è¿‡æ»¤å™¨ filter`,`ç›‘å¬å™¨ listener`,`æ‹¦æˆªå™¨ Interceptor`

  > [è¯·æ•™ä¸€ä¸‹å…³äºè¿‡æ»¤å™¨ï¼Œæ‹¦æˆªå™¨ï¼Œç›‘å¬å™¨å…·ä½“åº”ç”¨ä¸Šçš„åŒºåˆ«ï¼Ÿ](https://www.zhihu.com/question/35225845)

- ä¸‹é¢ä»‹ç» filter(é‡ç‚¹) å’Œ listener

---

### Filter è¿‡æ»¤å™¨

#### ä»‹ç»

> <img src="https://cdn.jsdelivr.net/gh/Weidows/Images/post/20210409222335.png" alt="20210409222335" />

æ¯”å¦‚å¤„ç†`ä¸­æ–‡ä¹±ç ,æ•æ„Ÿè¯æ±‡,ç™»å½•éªŒè¯`...

ä¾‹å­: æ¯”å¦‚ Shiro å®‰å…¨æ¡†æ¶æŠ€æœ¯å°±æ˜¯ç”¨ Filter æ¥å®ç°çš„

---

#### å¯¼å…¥ä¾èµ–

- è€å››æ ·:

  ```xml
  <!-- servletä¾èµ– -->
  <dependency>
    <groupId>javax.servlet</groupId>
    <artifactId>javax.servlet-api</artifactId>
    <version>4.0.1</version>
    <scope>provided</scope>
  </dependency>
  <!-- JSPä¾èµ– -->
  <dependency>
    <groupId>javax.servlet.jsp</groupId>
    <artifactId>javax.servlet.jsp-api</artifactId>
    <version>2.3.3</version>
    <scope>provided</scope>
  </dependency>
  <!-- JSTLè¡¨è¾¾å¼ä¾èµ– -->
  <dependency>
    <groupId>javax.servlet</groupId>
    <artifactId>jstl</artifactId>
    <version>1.2</version>
  </dependency>
  <!-- Standardæ ‡ç­¾åº“ -->
  <dependency>
    <groupId>taglibs</groupId>
    <artifactId>standard</artifactId>
    <version>1.1.2</version>
  </dependency>
  ```

  ***

- ä¹‹åå¥½åƒè¿˜ä¼šç”¨åˆ° SQL é©±åŠ¨ä¾èµ–,åˆ°æ—¶å€™åœ¨è¯´.

---

#### filter ä¾‹å­

- `src/main/java/filter/CharacterEncodingFilter.java`

  ```Java
  package filter;

  import javax.servlet.*;
  import java.io.IOException;

  public class CharacterEncodingFilter implements Filter {
    //åˆå§‹åŒ–å¹¶ç­‰å¾…è¿‡æ»¤å¯¹è±¡å‡ºç°
    @Override
    public void init(FilterConfig filterConfig) throws ServletException {
      System.out.println("CharacterEncodingFilteråˆå§‹åŒ–");
    }

    /*
      1. è¿‡æ»¤ä¸­çš„æ‰€æœ‰ä»£ç ï¼Œåœ¨è¿‡æ»¤ç‰¹å®šè¯·æ±‚çš„æ—¶å€™éƒ½ä¼šæ‰§è¡Œ
      2. å¿…é¡»è¦è®©è¿‡æ»¤å™¨ç»§ç»­æ‰§è¡Œ (å› ä¸ºfilterå¯èƒ½ä¸æ­¢ä¸€ä¸ª,éœ€è¦ä¼ é€’)
        chain.doFilter(request,response);
    */
    @Override
    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException {
      request.setCharacterEncoding("utf-8");
      response.setCharacterEncoding("utf-8");
      response.setContentType("text/html");

      System.out.println("CharacterEncodingFilteræ‰§è¡Œå‰....");
      chain.doFilter(request, response); //è®©æˆ‘ä»¬çš„è¯·æ±‚ç»§ç»­èµ°ï¼Œå¦‚æœä¸å†™ï¼Œç¨‹åºåˆ°è¿™é‡Œå°±è¢«æ‹¦æˆªåœæ­¢ï¼
      System.out.println("CharacterEncodingFilteræ‰§è¡Œå....");
    }

    //é”€æ¯ï¼šwebæœåŠ¡å™¨å…³é—­çš„æ—¶å€™ï¼Œè¿‡æ»¤å™¨ä¼šé”€æ¯
    @Override
    public void destroy() {
      System.out.println("CharacterEncodingFilteré”€æ¯");
    }
  }
  ```

  ***

- `src/main/java/servlet/Show.java`

  ```Java
  package servlet;

  import javax.servlet.ServletException;
  import javax.servlet.http.HttpServlet;
  import javax.servlet.http.HttpServletRequest;
  import javax.servlet.http.HttpServletResponse;
  import java.io.IOException;

  public class Show extends HttpServlet {
    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
      this.doPost(req, resp);
    }

    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
      // é€šè¿‡filterå®ç°å¤„ç†ä¹±ç 
      resp.getWriter().write("ä½ å¥½!");
    }
  }
  ```

  ***

- `web.xml` é…ç½® servlet å’Œ filter

```xml
<?xml version="1.0" encoding="UTF-8"?>
<web-app xmlns="http://xmlns.jcp.org/xml/ns/javaee"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd"
         version="4.0">
  <servlet>
    <servlet-name>show</servlet-name>
    <servlet-class>servlet.Show</servlet-class>
  </servlet>
  <filter>
    <filter-name>characterEncodingFilter</filter-name>
    <filter-class>filter.CharacterEncodingFilter</filter-class>
  </filter>

  <!--è¿˜æ˜¯ä¹±ç çš„é¡µé¢-->
  <servlet-mapping>
    <servlet-name>show</servlet-name>
    <url-pattern>/show</url-pattern>
  </servlet-mapping>
  <!--é€šè¿‡è¿‡æ»¤å™¨è§£å†³äº†ä¹±ç çš„é¡µé¢-->
  <servlet-mapping>
    <servlet-name>show</servlet-name>
    <url-pattern>/servlet/show</url-pattern>
  </servlet-mapping>
  <!--filterçš„åœ°å€æ˜ å°„-->
  <filter-mapping>
    <filter-name>characterEncodingFilter</filter-name>
    <url-pattern>/servlet/*</url-pattern>
  </filter-mapping>
</web-app>
```

<a>![åˆ†å‰²çº¿](https://cdn.jsdelivr.net/gh/Weidows/Images/img/divider.png)</a>

### ç›‘å¬å™¨

> - å¯¹åº”ä¸åŒä¸šåŠ¡éœ€æ±‚,å­˜åœ¨ N ä¸­ä¸åŒçš„ç›‘å¬å™¨æ¥å£å¯ä¾›å®ç°.
> - ç›‘å¬å™¨ç»å¸¸åœ¨ GUI ç¼–ç¨‹ä¸­ä½¿ç”¨.

- ä¾‹å­: è®¾ç½® session ç›‘å¬å™¨ç›‘å¬æœ‰å¤šå°‘ session è¿æ¥

- `src/main/java/listener/OnlineCountListener.java`

  ```Java
  package listener;

  import javax.servlet.ServletContext;
  import javax.servlet.http.HttpSessionEvent;
  import javax.servlet.http.HttpSessionListener;

  //ç»Ÿè®¡ç½‘ç«™åœ¨çº¿äººæ•° -> ç»Ÿè®¡session
  public class OnlineCountListener implements HttpSessionListener {
    private ServletContext ctx;
    private Integer onlineCount;

    //ä¸€æ—¦åˆ›å»ºSessionå°±ä¼šè§¦å‘ä¸€æ¬¡è¿™ä¸ªäº‹ä»¶
    public void sessionCreated(HttpSessionEvent se) {
      initParam(se);
      ctx.setAttribute("OnlineCount", ++onlineCount);
    }

    /*
      ä¸€æ—¦é”€æ¯Sessionå°±ä¼šè§¦å‘ä¸€æ¬¡è¿™ä¸ªäº‹ä»¶
      Sessioné”€æ¯ï¼š
        1. æ‰‹åŠ¨é”€æ¯  getSession().invalidate();
        2. è‡ªåŠ¨é”€æ¯
    */
    public void sessionDestroyed(HttpSessionEvent se) {
      initParam(se);
      ctx.setAttribute("OnlineCount", --onlineCount);
    }

    public void initParam(HttpSessionEvent se) {
      ctx = se.getSession().getServletContext();
      onlineCount = (Integer) ctx.getAttribute("OnlineCount");

      if (onlineCount == null) {
        ctx.setAttribute("OnlineCount", 0);
      }
    }
  }
  ```

  ***

- `index.jsp`

  ```jsp
  <%@ page contentType="text/html;charset=UTF-8" language="java" %>
  <html>
  <head>
    <title>åœ¨çº¿äººæ•°æµ‹è¯•</title>
  </head>
  <body>
  <h1>å½“å‰æœ‰ <span
      style="color: turquoise;"><%=this.getServletConfig().getServletContext().getAttribute("OnlineCount")%></span> äººåœ¨çº¿
  </h1>
  </body>
  </html>
  ```

  ***

- `æ³¨å†Œç›‘å¬å™¨`

  ```xml
    <!--æ³¨å†Œç›‘å¬å™¨-->
    <listener>
      <listener-class>listener.OnlineCountListener</listener-class>
    </listener>
  ```

---

### GUI ç¼–ç¨‹ä¾‹å­

- GUI ç¼–ç¨‹å¸¸ä¼šç”¨åˆ°ç›‘å¬å™¨,è¿™é‡Œç®€å•ä»‹ç»ä¸€ä¸‹ : `src/main/java/listener/TestPanel.java`

  ```Java
  package listener;

  import java.awt.*;
  import java.awt.event.WindowAdapter;
  import java.awt.event.WindowEvent;

  public class TestPanel {
    public static void main(String[] args) {
      Frame frame = new Frame("Hello World!");  //æ–°å»ºä¸€ä¸ªçª—ä½“
      Panel panel = new Panel(null); //é¢æ¿
      frame.setLayout(null); //è®¾ç½®çª—ä½“çš„å¸ƒå±€

      frame.setBounds(300, 300, 500, 500);
      frame.setBackground(new Color(0, 0, 255)); //è®¾ç½®èƒŒæ™¯é¢œè‰²

      panel.setBounds(50, 50, 300, 300);
      panel.setBackground(new Color(0, 255, 0)); //è®¾ç½®èƒŒæ™¯é¢œè‰²

      frame.add(panel);

      frame.setVisible(true);

      //ç›‘å¬äº‹ä»¶ï¼Œç›‘å¬å…³é—­äº‹ä»¶
      frame.addWindowListener(new WindowAdapter() {
        @Override
        public void windowClosing(WindowEvent e) {
          System.exit(0);
        }
      });
    }
  }
  ```

---

### ç™»å½•éªŒè¯ demo

- é¡¹ç›®ç»“æ„,å¦‚å›¾:

  <img src="https://cdn.jsdelivr.net/gh/Weidows/Images/post/20210411004248.png" alt="20210411004248" />

  ***

- JSP é¡µé¢

  - ä¸»é¡µ(ç™»å½•é¡µé¢): `web/demo/index.jsp`

    ```jsp
    <%@ page contentType="text/html;charset=UTF-8" language="java" %>
    <html>
    <head>
      <title>ä¸»é¡µ</title>
    </head>
    <body>
    <h1>ç™»å½•</h1>
    <form action="${pageContext.request.contextPath}/demo/login" method="post">
      <label>
        ç”¨æˆ·å:
        <input type="text" name="username"/>
      </label>
      <input type="submit" value="ç™»å½•">
    </form>
    </body>
    </html>
    ```

  ***

  - ç™»é™†å¤±è´¥: `web/demo/failed.jsp`

    ```jsp
    <%@ page contentType="text/html;charset=UTF-8" language="java" %>
    <html>
    <head>
      <title>ç™»å½•å¤±è´¥</title>
    </head>
    <body>
    <h1>ç™»å½•å¤±è´¥è¿›å…¥çš„é¡µé¢</h1>

    <a href="${pageContext.request.contextPath}/demo/index.jsp">è¿”å›ä¸»é¡µ</a>
    </body>
    </html>
    ```

  ***

  - ç™»å½•æˆåŠŸ: `web/demo/sys/success.jsp`

    ```jsp
    <%@ page contentType="text/html;charset=UTF-8" language="java" %>
    <html>
    <head>
      <title>å·²ç™»å½•</title>
    </head>
    <body>
    <h1>ç™»å½•æˆåŠŸåè¿›å…¥çš„é¡µé¢</h1>

    <hr>

    <a href="${pageContext.request.contextPath}/demo/logout">æ³¨é”€</a>
    </body>
    </html>
    ```

---

- Java åç«¯

  - login: `src/main/java/demo/servlet/Login.java`

    ```Java
    package demo.servlet;

    import demo.utils.Constants;

    import javax.servlet.http.HttpServlet;
    import javax.servlet.http.HttpServletRequest;
    import javax.servlet.http.HttpServletResponse;
    import javax.servlet.http.HttpSession;
    import java.io.IOException;

    public class Login extends HttpServlet {
      @Override
      protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws IOException {
        this.doPost(req, resp);
      }

      @Override
      protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws IOException {
        String username = req.getParameter("username");
        HttpSession session = req.getSession();

        if (username.equals("admin")) {
          session.setAttribute(Constants.USER_SESSION, session.getId());
          resp.sendRedirect("/demo/sys/success.jsp");
        } else {
          resp.sendRedirect("/demo/failed.jsp");
        }
      }
    }
    ```

  ***

  - æ³¨é”€: `src/main/java/demo/servlet/Logout.java`

    ```Java
    package demo.servlet;

    import demo.utils.Constants;

    import javax.servlet.ServletException;
    import javax.servlet.http.HttpServlet;
    import javax.servlet.http.HttpServletRequest;
    import javax.servlet.http.HttpServletResponse;
    import javax.servlet.http.HttpSession;
    import java.io.IOException;

    public class Logout extends HttpServlet {
      @Override
      protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        doPost(req, resp);
      }

      @Override
      protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {

        HttpSession session = req.getSession();
        Object attribute = session.getAttribute(Constants.USER_SESSION);

        /*
          é¢‘ç¹æ“ä½œsessionè¿æ¥ä¼šå½±å“æ€§èƒ½,é€šè¿‡attributeé—´æ¥éªŒè¯ç™»å½•ä¿¡æ¯
          é€šè¿‡è®¾ç½®æˆ–ç§»é™¤ USER_SESSION å±æ€§æ¥éªŒè¯æ˜¯å¦ç™»å½•
          å­˜åœ¨ä¸€ä¸ªBug: åœ¨æ³¨é”€çŠ¶æ€é€šè¿‡æµè§ˆå™¨çš„åé€€,å¯ä»¥è¿”å›ç™»é™†æˆåŠŸçš„é¡µé¢(ä¸”ä¸å­˜åœ¨USER_SESSION)
        */
        if (attribute != null) {
          session.removeAttribute(Constants.USER_SESSION);
          resp.sendRedirect("/demo/index.jsp");
        }
      }
    ```

  ***

  - æå–çš„å¸¸é‡å·¥å…·ç±»: `src/main/java/demo/utils/Constants.java`

    ```Java
    package demo.utils;

    /**
    * æ­¤ç±»å†…å®šä¹‰ä¸€äº›å…¶ä»–å„ç§åœ°æ–¹éœ€è¦ç»å¸¸è°ƒç”¨çš„å¸¸é‡
    */
    public class Constants {
      public final static String USER_SESSION = "USER_SESSION";
    }
    ```

  ***

  - è¿‡æ»¤å™¨ç±»: `src/main/java/demo/filter/SysFilter.java`

    ```Java
    package demo.filter;

    import demo.utils.Constants;

    import javax.servlet.*;
    import javax.servlet.http.HttpServletRequest;
    import javax.servlet.http.HttpServletResponse;
    import java.io.IOException;

    public class SysFilter implements Filter {
      @Override
      public void init(FilterConfig filterConfig) throws ServletException {

      }

      @Override
      public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException {
        HttpServletRequest req = (HttpServletRequest) request;
        HttpServletResponse resp = (HttpServletResponse) response;

        Object attribute = req.getSession().getAttribute(Constants.USER_SESSION);
        if (attribute == null) {
          resp.sendRedirect("/demo/failed.jsp");
        }

        chain.doFilter(request, response);
      }

      @Override
      public void destroy() {

      }
    }
    ```

---

- `Web.xml`

  ```xml
  <servlet>
    <servlet-name>login</servlet-name>
    <servlet-class>demo.servlet.Login</servlet-class>
  </servlet>
  <servlet>
    <servlet-name>logout</servlet-name>
    <servlet-class>demo.servlet.Logout</servlet-class>
  </servlet>
  <filter>
    <filter-name>sysFilter</filter-name>
    <filter-class>demo.filter.SysFilter</filter-class>
  </filter>

  <servlet-mapping>
    <servlet-name>login</servlet-name>
    <url-pattern>/demo/login</url-pattern>
  </servlet-mapping>
  <servlet-mapping>
    <servlet-name>logout</servlet-name>
    <url-pattern>/demo/logout</url-pattern>
  </servlet-mapping>
  <filter-mapping>
    <filter-name>sysFilter</filter-name>
    <url-pattern>/demo/sys/*</url-pattern>
  </filter-mapping>
  ```
