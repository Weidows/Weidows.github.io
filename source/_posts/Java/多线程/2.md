---
title: ğŸŒ­å›é¡¾ä¸€ä¸‹å¤šçº¿ç¨‹-è´°
date: 2021-02-21 01:06:22
password: ""
tags:
  - Java
  - å¤šçº¿ç¨‹
  - ç¬”è®°
cover: https://www.helloimg.com/images/2022/02/27/GVPsrE.png
top_img:
---

# å›é¡¾ä¸€ä¸‹å¤šçº¿ç¨‹-è´°

<!--
 * @?: *********************************************************************
 * @Author: Weidows
 * @LastEditors: Weidows
 * @LastEditTime: 2022-04-20 23:41:35
 * @FilePath: \Blog-private\source\_posts\Java\å¤šçº¿ç¨‹\2.md
 * @Description:
 * @!: *********************************************************************
-->

{% pullquote mindmap mindmap-md %}

- [å›é¡¾ä¸€ä¸‹å¤šçº¿ç¨‹-è´°](#å›é¡¾ä¸€ä¸‹å¤šçº¿ç¨‹-è´°)
  - [çº¿ç¨‹åŒæ­¥-synchronized](#çº¿ç¨‹åŒæ­¥-synchronized)
    - [ä¹°ç¥¨](#ä¹°ç¥¨)
    - [é“¶è¡Œå–æ¬¾](#é“¶è¡Œå–æ¬¾)
    - [å…³äºè¯•é”™æŠ€å·§](#å…³äºè¯•é”™æŠ€å·§)
  - [é›†åˆä¸çº¿ç¨‹å®‰å…¨](#é›†åˆä¸çº¿ç¨‹å®‰å…¨)
    - [éçº¿ç¨‹åŒæ­¥](#éçº¿ç¨‹åŒæ­¥)
    - [çº¿ç¨‹åŒæ­¥](#çº¿ç¨‹åŒæ­¥)
    - [çº¿ç¨‹å®‰å…¨é›†åˆ](#çº¿ç¨‹å®‰å…¨é›†åˆ)
  - [æ­»é”](#æ­»é”)
    - [äº§ç”Ÿæ¡ä»¶](#äº§ç”Ÿæ¡ä»¶)
    - [è§£å†³æ–¹æ¡ˆ](#è§£å†³æ–¹æ¡ˆ)
  - [å¯é‡å…¥é”-ReentrantLock](#å¯é‡å…¥é”-reentrantlock)
  - [å¤šçº¿ç¨‹ä¸å¾ªç¯æ§åˆ¶](#å¤šçº¿ç¨‹ä¸å¾ªç¯æ§åˆ¶)
  - [å»¶è¿Ÿå¯¹å¤šçº¿ç¨‹çš„å½±å“](#å»¶è¿Ÿå¯¹å¤šçº¿ç¨‹çš„å½±å“)
    - [ä¸€](#ä¸€)
    - [äºŒ](#äºŒ)
    - [ä¸‰](#ä¸‰)
  - [çº¿ç¨‹é€šä¿¡-wait-notify](#çº¿ç¨‹é€šä¿¡-wait-notify)
  - [çº¿ç¨‹æ± ](#çº¿ç¨‹æ± )

{% endpullquote %}

<a>![åˆ†å‰²çº¿](https://fastly.jsdelivr.net/gh/Weidows/Images/img/divider.png)</a>

## çº¿ç¨‹åŒæ­¥-synchronized

- å¤šä¸ªçº¿ç¨‹æ“ä½œåŒä¸€èµ„æºæ—¶ä¼šæœ‰é—®é¢˜å‡ºç°,ç”¨ `synchronized` åŒæ­¥.

  çº¿ç¨‹åŒæ­¥çš„å½¢æˆæ¡ä»¶: `é˜Ÿåˆ—+é”`

  å®ç°å½¢å¼æœ‰ åŒæ­¥æ–¹æ³• å’Œ åŒæ­¥ä»£ç å—

  ***

1. åŒæ­¥æ–¹æ³•, é”çš„æ˜¯æ–¹æ³•æ‰€å±å¯¹è±¡ this

   å¦‚ä¸‹ä¹°ç¥¨ä¾‹å­ä¸­ buy æ–¹æ³•é”çš„æ˜¯ `Ticket ticket` è¿™ä¸ªå¯¹è±¡

   ```
   public synchronized void buy() {}
   ```

   ***

2. åŒæ­¥ä»£ç å—, é” obj

   ```
   synchronized (obj) {
     // æ“ä½œ
   }
   ```

---

### ä¹°ç¥¨

```Java
public class Ticket implements Runnable {
  private int ticketNums = 10; //ç¥¨æ•°
  boolean flag = true; //å¤–éƒ¨åœæ­¢æ–¹æ³•

  @Override
  public void run() {
    while (flag) {
      buy();
      //æ¨¡æ‹Ÿå»¶æ—¶
      try {
        Thread.sleep(200);
      } catch (InterruptedException e) {
        e.printStackTrace();
      }
    }
  }

  public synchronized void buy() {
    //åˆ¤æ–­æ˜¯å¦æœ‰ç¥¨
    if (ticketNums <= 0) {
      flag = false;
      return;
    }
    System.out.println(Thread.currentThread().getName() + "-->å¾—åˆ°å€’æ•°ç¬¬" + ticketNums-- + "ç¥¨");
  }

  public static void main(String[] args) {
    Ticket ticket = new Ticket();

    new Thread(ticket, "å°æ˜").start();
    new Thread(ticket, "è€å¸ˆ").start();
    new Thread(ticket, "é»„ç‰›").start();
  }
}
```

- ç»“æœ

  ä¸åŠ é”: æœ‰é”™è¯¯

  ```
  å°æ˜-->å¾—åˆ°å€’æ•°ç¬¬10ç¥¨
  è€å¸ˆ-->å¾—åˆ°å€’æ•°ç¬¬9ç¥¨
  é»„ç‰›-->å¾—åˆ°å€’æ•°ç¬¬8ç¥¨
  è€å¸ˆ-->å¾—åˆ°å€’æ•°ç¬¬7ç¥¨
  å°æ˜-->å¾—åˆ°å€’æ•°ç¬¬6ç¥¨
  é»„ç‰›-->å¾—åˆ°å€’æ•°ç¬¬5ç¥¨
  è€å¸ˆ-->å¾—åˆ°å€’æ•°ç¬¬4ç¥¨
  å°æ˜-->å¾—åˆ°å€’æ•°ç¬¬3ç¥¨
  é»„ç‰›-->å¾—åˆ°å€’æ•°ç¬¬3ç¥¨
  è€å¸ˆ-->å¾—åˆ°å€’æ•°ç¬¬2ç¥¨
  å°æ˜-->å¾—åˆ°å€’æ•°ç¬¬1ç¥¨
  é»„ç‰›-->å¾—åˆ°å€’æ•°ç¬¬1ç¥¨
  ```

  åŠ é”: æ— è¯¯

  ```
  å°æ˜-->å¾—åˆ°å€’æ•°ç¬¬10ç¥¨
  é»„ç‰›-->å¾—åˆ°å€’æ•°ç¬¬9ç¥¨
  è€å¸ˆ-->å¾—åˆ°å€’æ•°ç¬¬8ç¥¨
  å°æ˜-->å¾—åˆ°å€’æ•°ç¬¬7ç¥¨
  é»„ç‰›-->å¾—åˆ°å€’æ•°ç¬¬6ç¥¨
  è€å¸ˆ-->å¾—åˆ°å€’æ•°ç¬¬5ç¥¨
  é»„ç‰›-->å¾—åˆ°å€’æ•°ç¬¬4ç¥¨
  å°æ˜-->å¾—åˆ°å€’æ•°ç¬¬3ç¥¨
  è€å¸ˆ-->å¾—åˆ°å€’æ•°ç¬¬2ç¥¨
  é»„ç‰›-->å¾—åˆ°å€’æ•°ç¬¬1ç¥¨
  ```

<a>![åˆ†å‰²çº¿](https://fastly.jsdelivr.net/gh/Weidows/Images/img/divider.png)</a>

### é“¶è¡Œå–æ¬¾

```Java
import java.math.BigDecimal;

public class Bank {
  public static void main(String[] args) {
    Account account = new Account(new BigDecimal(100), "æˆ‘çš„è´¦æˆ·");

    DrawingChannel a = new DrawingChannel(account, new BigDecimal(50), "A");
    DrawingChannel b = new DrawingChannel(account, new BigDecimal(100), "B");

    a.start();
    b.start();
  }
}

//è´¦æˆ·
class Account {
  BigDecimal balance;//ä½™é¢
  final String name; //å¡å

  public Account(BigDecimal balance, String name) {
    this.balance = balance;
    this.name = name;
  }
}

/**
 * é“¶è¡Œï¼šæ¨¡æ‹Ÿå–æ¬¾
 * * è¿™é‡Œä¹‹æ‰€ä»¥æ²¡ç”¨å®ç°Runnableæ¥å£çš„æ–¹å¼æ˜¯ä¸ºäº†è°ƒç”¨Threadç±»ä¸­ä¸€äº›æ–¹æ³•
 */
class DrawingChannel extends Thread {
  final Account account; //è´¦æˆ·
  BigDecimal drawingMoney; //å–äº†å¤šå°‘é’±
  BigDecimal nowMoney; //ç°åœ¨æ‰‹é‡Œæœ‰å¤šå°‘é’±

  public DrawingChannel(Account account, BigDecimal drawingMoney, String name) {
    super(name);
    this.account = account;
    this.drawingMoney = drawingMoney;
    this.nowMoney = new BigDecimal(0);
  }

  @Override
  public void run() {
    synchronized (account) {
      //åˆ¤æ–­æœ‰æ²¡æœ‰é’±
      if (account.balance.compareTo(drawingMoney) < 0) {
        System.out.println(account.name + "é’±ä¸å¤Ÿ" + drawingMoney + "," + this.getName() + "æ— æ³•å–èµ°");
        return;
      }

      // æ”¾å¤§é”™è¯¯
      try {
        sleep(1000);
      } catch (InterruptedException e) {
        e.printStackTrace();
      }
      draw();
    }
  }

  private void draw() {
    //å¡å†…ä½™é¢ = ä½™é¢ - å–çš„é’±
    account.balance = account.balance.subtract(drawingMoney);
    System.out.println(this.getName() + "å–èµ°" + drawingMoney);

    //æ‰‹é‡Œçš„é’±
    nowMoney = nowMoney.add(drawingMoney);

    System.out.println(account.name + "ä½™é¢ä¸ºï¼š" + account.balance);
    System.out.println(this.getName() + "æ‰‹é‡Œçš„é’±ï¼š" + nowMoney);
  }
}
```

- é¢„æœŸç»“æœ

  ```
  Aå–èµ°50
  æˆ‘çš„è´¦æˆ·ä½™é¢ä¸ºï¼š50
  Aæ‰‹é‡Œçš„é’±ï¼š50
  æˆ‘çš„è´¦æˆ·é’±ä¸å¤Ÿ100,Bæ— æ³•å–èµ°
  ```

---

### å…³äºè¯•é”™æŠ€å·§

- ç†Ÿç»ƒä½¿ç”¨.sleep()è¯•é”™

  - è¯•é”™å‰

    ```
    æˆ‘çš„è´¦æˆ·é’±ä¸å¤Ÿ100,Bæ— æ³•å–èµ°
    æˆ‘çš„è´¦æˆ·ä½™é¢ä¸ºï¼š50
    Aæ‰‹é‡Œçš„é’±ï¼š50
    ```

  ***

  - è¯•é”™å

    ```
    B å–èµ° 100
    A å–èµ° 50
    æˆ‘çš„è´¦æˆ·ä½™é¢ä¸ºï¼š50
    æˆ‘çš„è´¦æˆ·ä½™é¢ä¸ºï¼š50
    A æ‰‹é‡Œçš„é’±ï¼š50
    B æ‰‹é‡Œçš„é’±ï¼š100
    ```

<a>![åˆ†å‰²çº¿](https://fastly.jsdelivr.net/gh/Weidows/Images/img/divider.png)</a>

## é›†åˆä¸çº¿ç¨‹å®‰å…¨

å¤šä¸ªçº¿ç¨‹åŒæ—¶æ“ä½œé›†åˆå¯¹è±¡æ—¶å¯èƒ½ä¼šå­˜åœ¨è¦†å†™(çº¿ç¨‹ä¸å®‰å…¨)

### éçº¿ç¨‹åŒæ­¥

```Java
public class TestList {
  public static void main(String[] args) throws InterruptedException {
    List<String> list = new ArrayList<String>();

    for (int i = 0; i < 10000; i++) {
      new Thread(() -> {
        list.add(Thread.currentThread().getName());
      }).start();
    }
    Thread.sleep(3000); // å»¶æ—¶,ä¸ºäº†ç­‰ä¸Šé¢æ‰§è¡Œå®Œæ¯•
    System.out.println(list.size());//è¾“å‡ºï¼š9992
  }
}
```

---

### çº¿ç¨‹åŒæ­¥

```Java
public class TestList {
  public static void main(String[] args) throws InterruptedException {
    List<String> list = new ArrayList<String>();

    for (int i = 0; i < 10000; i++) {
      new Thread(() -> {
        synchronized (list) {
          list.add(Thread.currentThread().getName());
        }
      }).start();
    }
    Thread.sleep(3000); // å»¶æ—¶,ä¸ºäº†ç­‰ä¸Šé¢æ‰§è¡Œå®Œæ¯•
    System.out.println(list.size());//è¾“å‡ºï¼š10000
  }
}
```

---

### çº¿ç¨‹å®‰å…¨é›†åˆ

```Java
public class JUC {
  public static void main(String[] args) throws InterruptedException {
    List<String> list = new CopyOnWriteArrayList<String>();

    for (int i = 0; i < 10000; i++) {
      new Thread(() -> {
        list.add(Thread.currentThread().getName());
      }).start();
    }

    Thread.sleep(3000);
    System.out.println(list.size());//è¾“å‡ºï¼š10000
  }
}
```

<a>![åˆ†å‰²çº¿](https://fastly.jsdelivr.net/gh/Weidows/Images/img/divider.png)</a>

## æ­»é”

ä¸¤çº¿ç¨‹åœ¨å„è‡ªæ‹¥æœ‰ä¸€ä¸ªå¯¹è±¡çš„é”æ—¶éƒ½ç­‰å¾…å¯¹æ–¹çº¿ç¨‹é‡Šæ”¾å¯¹è±¡çš„é” ; ä¹Ÿæœ‰å¯èƒ½å¾ˆå¤šçº¿ç¨‹äº§ç”Ÿç¯å½¢/ç½‘çŠ¶æ­»é”.

- å¦‚ä¸‹ä¾‹å­å°±ä¼šäº§ç”Ÿæ­»é”

  ```Java
  //æ­»é”ï¼šå¤šä¸ªçº¿ç¨‹äº’ç›¸æŠ±ç€å¯¹æ–¹éœ€è¦çš„èµ„æº
  public class DeadLock {
    public static void main(String[] args) {
      Makeup m1 = new Makeup(0, "å°é»‘");
      Makeup m2 = new Makeup(1, "å°ç™½");

      m1.start();
      m2.start();
    }
  }

  //å£çº¢
  class Lipstick {
  }

  //é•œå­
  class Mirror {
  }

  //åŒ–å¦†
  class Makeup extends Thread {
    //éœ€è¦çš„èµ„æºåªæœ‰ä¸€ä»½ï¼Œç”¨staticæ¥ä¿è¯åªæœ‰ä¸€ä»½
    static final Lipstick lipstick = new Lipstick();
    static final Mirror mirror = new Mirror();

    int choice; //é€‰æ‹©
    String name; //ä½¿ç”¨åŒ–å¦†å“çš„äºº

    public Makeup(int choice, String name) {
      this.choice = choice;
      this.name = name;
    }

    @Override
    public void run() {
      //åŒ–å¦†
      try {
        makeup();
      } catch (InterruptedException e) {
        e.printStackTrace();
      }
    }

    //åŒ–å¦†ï¼Œäº’ç›¸æŒæœ‰å¯¹æ–¹çš„é”ï¼Œå°±æ˜¯éœ€è¦æ‹¿åˆ°å¯¹æ–¹çš„èµ„æº
    private void makeup() throws InterruptedException {
      if (choice == 0) {
        synchronized (lipstick) { //è·å¾—å£çº¢çš„é”
          System.out.println(this.name + "è·å¾—å£çº¢çš„é”");
          Thread.sleep(1000);

          synchronized (mirror) { //ä¸€ç§’é’Ÿåæƒ³è·å¾—é•œå­çš„é”
            System.out.println(this.name + "è·å¾—é•œå­çš„é”");
          }
        }
      } else {
        synchronized (mirror) { //è·å¾—é•œå­çš„é”
          System.out.println(this.name + "è·å¾—é•œå­çš„é”");
          Thread.sleep(2000);
          synchronized (lipstick) { //ä¸¤ç§’é’Ÿåæƒ³è·å¾—å£çº¢çš„é”
            System.out.println(this.name + "è·å¾—å£çº¢çš„é”");
          }
        }
      }
    }
  }
  ```

---

### äº§ç”Ÿæ¡ä»¶

- å››ä¸ªå¿…è¦æ¡ä»¶:

  1. äº’æ–¥æ¡ä»¶ï¼šä¸€ä¸ªèµ„æºæ¯æ¬¡åªèƒ½è¢«ä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨ã€‚
  2. è¯·æ±‚ä¸ä¿æŒæ¡ä»¶ï¼šä¸€ä¸ªè¿›ç¨‹å› è¯·æ±‚èµ„æºè€Œé˜»å¡æ—¶ï¼Œå¯¹å·²è·å¾—çš„èµ„æºä¿æŒä¸æ”¾ã€‚
  3. ä¸å‰¥å¤ºæ¡ä»¶ï¼šè¿›ç¨‹å·²è·å¾—çš„èµ„æºï¼Œåœ¨æœªä½¿ç”¨å®Œä¹‹å‰ä¸èƒ½å¼ºè¡Œå‰¥å¤ºã€‚
  4. å¾ªç¯ç­‰å¾…æ¡ä»¶ï¼šè‹¥å¹²è¿›ç¨‹ä¹‹é—´å½¢æˆä¸€ç§å¤´å°¾ç›¸æ¥çš„å¾ªç¯ç­‰å¾…èµ„æºå…³ç³»ã€‚

---

### è§£å†³æ–¹æ¡ˆ

- ä½¿ç”¨å®ŒåŒæ­¥å¯¹è±¡åç«‹å³é‡Šæ”¾

  - æ¯”å¦‚ä¸Šé¢çš„ä¾‹å­ä¸­ä½¿ç”¨å®Œ`å£çº¢`æˆ–è€…`é•œå­`åæœªé‡Šæ”¾,å†å»è·å–å¦ä¸€ä¸ªå¯¹è±¡çš„é”,å°±ä¼šäº§ç”Ÿæ­»é”äº†
  - ä¿®æ”¹: æŠŠ makeup æ”¹ä¸ºå¦‚ä¸‹

  ```Java
  private void makeup() throws InterruptedException {
    if (choice == 0) {
      synchronized (lipstick) { // è·å¾—å£çº¢çš„é”
        System.out.println(this.name + "è·å¾—å£çº¢çš„é”");
        Thread.sleep(1000);
      }
      synchronized (mirror) { // ä¸€ç§’é’Ÿåæƒ³è·å¾—é•œå­çš„é”
        System.out.println(this.name + "è·å¾—é•œå­çš„é”");
      }
    } else {
      synchronized (mirror) { // è·å¾—é•œå­çš„é”
        System.out.println(this.name + "è·å¾—é•œå­çš„é”");
        Thread.sleep(2000);
      }
      synchronized (lipstick) { // ä¸¤ç§’é’Ÿåæƒ³è·å¾—å£çº¢çš„é”
        System.out.println(this.name + "è·å¾—å£çº¢çš„é”");
      }
    }
  }
  ```

<a>![åˆ†å‰²çº¿](https://fastly.jsdelivr.net/gh/Weidows/Images/img/divider.png)</a>

## å¯é‡å…¥é”-ReentrantLock

- ReentrantLock (ä¹Ÿå« RT-Lock) ç±»å®ç°äº† java.util.concurrent.locks.Lock æ¥å£

  ä¸ synchronized åŒºåˆ«:

  1. ReentrantLock æ˜¯æ˜¾å¼åŠ è§£é”,å®ƒåªèƒ½é”ä»£ç å—

  2. æ€§èƒ½æ¯” synchronized å¥½

- ä½¿ç”¨ä¼˜å…ˆåº¦: ReentrantLock > åŒæ­¥ä»£ç å—(å·²ç»è¿›å…¥äº†æ–¹æ³•ä½“ï¼Œåˆ†é…äº†ç›¸åº”èµ„æº) > åŒæ­¥æ–¹æ³•(åœ¨æ–¹æ³•ä½“ä¹‹å¤–)

- æ³¨æ„ç‚¹: åŠ è§£é”æœ€å¥½è¦åœ¨ try-finally é‡Œ

  ```Java
  try {
  while (true) {
    lock.lock();
    try {
      if ( ) {
        // ...
      } else {
        // ...
      }
    } catch (InterruptedException ignored) {
    } finally {
      lock.unlock();
    }
  }
  ```

- ä¾‹å­

  ```Java
  public class TestLock implements Runnable {
    int ticketNums = 10;
    private final ReentrantLock lock = new ReentrantLock(); // å®šä¹‰Locké”

    @Override
    public void run() {
      while (true) {
        try {
          lock.lock(); // åŠ é”
          if (ticketNums > 0) {
            System.out.println(Thread.currentThread().getName() + "-->æ‹¿åˆ°äº†ç¬¬" + ticketNums-- + "ç¥¨");
          } else {
            break;
          }
        } finally {
          lock.unlock(); // è§£é”
          try {
            Thread.sleep(500);
          } catch (InterruptedException e) {
            e.printStackTrace();
          }
        }
      }
    }

    public static void main(String[] args) {
      TestLock testLock = new TestLock();

      new Thread(testLock, "a").start();
      new Thread(testLock, "b").start();
      new Thread(testLock, "c").start();
    }
  }
  ```

- ç»“æœ

  ```
  a-->æ‹¿åˆ°äº†ç¬¬10ç¥¨
  c-->æ‹¿åˆ°äº†ç¬¬9ç¥¨
  b-->æ‹¿åˆ°äº†ç¬¬8ç¥¨
  b-->æ‹¿åˆ°äº†ç¬¬7ç¥¨
  c-->æ‹¿åˆ°äº†ç¬¬6ç¥¨
  a-->æ‹¿åˆ°äº†ç¬¬5ç¥¨
  b-->æ‹¿åˆ°äº†ç¬¬4ç¥¨
  a-->æ‹¿åˆ°äº†ç¬¬3ç¥¨
  c-->æ‹¿åˆ°äº†ç¬¬2ç¥¨
  c-->æ‹¿åˆ°äº†ç¬¬1ç¥¨
  ```

<a>![åˆ†å‰²çº¿](https://fastly.jsdelivr.net/gh/Weidows/Images/img/divider.png)</a>

## å¤šçº¿ç¨‹ä¸å¾ªç¯æ§åˆ¶

```Java
public class TestLock implements Runnable {
  int ticketNums = 10;
  private final ReentrantLock lock = new ReentrantLock(); // å®šä¹‰Locké”

  @Override
  public void run() {
    while (ticketNums > 0) {
      try {
        lock.lock(); // åŠ é”
        Thread.sleep(500);
        System.out.println(Thread.currentThread().getName() + "-->æ‹¿åˆ°äº†ç¬¬" + ticketNums-- + "ç¥¨");
      } catch (InterruptedException e) {
        e.printStackTrace();
      } finally {
        lock.unlock(); // è§£é”
      }
    }
  }

  public static void main(String[] args) {
    TestLock testLock = new TestLock();

    new Thread(testLock, "a").start();
    new Thread(testLock, "b").start();
    new Thread(testLock, "c").start();
  }
}
```

- ä¸Šé¢ä»£ç  while å¾ªç¯ä¼šå­˜åœ¨åˆ¤æ–­å¤±è¯¯

  ```
  c-->æ‹¿åˆ°äº†ç¬¬10ç¥¨
  c-->æ‹¿åˆ°äº†ç¬¬9ç¥¨
  c-->æ‹¿åˆ°äº†ç¬¬8ç¥¨
  c-->æ‹¿åˆ°äº†ç¬¬7ç¥¨
  c-->æ‹¿åˆ°äº†ç¬¬6ç¥¨
  c-->æ‹¿åˆ°äº†ç¬¬5ç¥¨
  c-->æ‹¿åˆ°äº†ç¬¬4ç¥¨
  c-->æ‹¿åˆ°äº†ç¬¬3ç¥¨
  c-->æ‹¿åˆ°äº†ç¬¬2ç¥¨
  c-->æ‹¿åˆ°äº†ç¬¬1ç¥¨
  b-->æ‹¿åˆ°äº†ç¬¬0ç¥¨
  a-->æ‹¿åˆ°äº†ç¬¬-1ç¥¨
  ```

- ticketNums åœ¨åˆ¤æ–­ä¹‹åè¢«å¤šæ¬¡ä¿®æ”¹

  ä¸Šé¢ 10~1 æ¬¡éƒ½æ˜¯ c çº¿ç¨‹æ‰§è¡Œçš„,å®ƒæ‰§è¡Œåè½®åˆ° b å’Œ a

  ä½†æ˜¯ b ä¸ a çº¿ç¨‹å®é™…ä¸Šæ˜¯åœ¨`ticketNums=10`æ—¶è¿›å…¥çš„å¾ªç¯,æ‰€ä»¥ä¼šå¯¼è‡´`-1`å‡ºç°

  æ‰€ä»¥å»ºè®®é‡åˆ°å¤šçº¿ç¨‹å¾ªç¯æ§åˆ¶æ—¶,ç›´æ¥`while(true)`,ç„¶ååœ¨å†…éƒ¨ç”¨`if`

  (åè¿‡æ¥æƒ³: æ˜¯å› ä¸º lock ä¸èƒ½åœ¨å¾ªç¯ä¹‹å¤–åŠ )

<a>![åˆ†å‰²çº¿](https://fastly.jsdelivr.net/gh/Weidows/Images/img/divider.png)</a>

## å»¶è¿Ÿå¯¹å¤šçº¿ç¨‹çš„å½±å“

> ä¸‹é¢ä¸‰ä¸ªä¾‹å­æ•°æ®éƒ½æ²¡é”™,å…³é”®çœ‹å¹¶å‘æ•°é‡å’Œæ‰§è¡Œæ—¶é—´

### ä¸€

- ç¬é—´æ‰§è¡Œå®Œ,èµ„æºè¢«å•ä¸€çº¿ç¨‹å…¨éƒ¨æŠ¢å  (å¹¶éä¸åˆç†,åªä¸è¿‡æ˜¯å¤„ç†å™¨æ²¡åˆ†é…åˆ° B,C)

  ```Java
  public class TestLock implements Runnable {
    int ticketNums = 10;
    private final ReentrantLock lock = new ReentrantLock(); // å®šä¹‰Locké”

    @Override
    public void run() {
      while (true) {
        try {
          lock.lock(); // åŠ é”
          if (ticketNums > 0) {
            System.out.println(Thread.currentThread().getName() + "-->æ‹¿åˆ°äº†ç¬¬" + ticketNums-- + "ç¥¨");
          } else {
            break;
          }
        } finally {
          lock.unlock(); // è§£é”
          // try {
          //   Thread.sleep(500);
          // } catch (InterruptedException e) {
          //   e.printStackTrace();
          // }
        }
      }
    }

    public static void main(String[] args) {
      TestLock testLock = new TestLock();

      new Thread(testLock, "a").start();
      new Thread(testLock, "b").start();
      new Thread(testLock, "c").start();
    }
  }
  ```

  ```
  c-->æ‹¿åˆ°äº†ç¬¬9ç¥¨
  c-->æ‹¿åˆ°äº†ç¬¬8ç¥¨
  c-->æ‹¿åˆ°äº†ç¬¬7ç¥¨
  c-->æ‹¿åˆ°äº†ç¬¬6ç¥¨
  c-->æ‹¿åˆ°äº†ç¬¬5ç¥¨
  c-->æ‹¿åˆ°äº†ç¬¬4ç¥¨
  c-->æ‹¿åˆ°äº†ç¬¬3ç¥¨
  c-->æ‹¿åˆ°äº†ç¬¬2ç¥¨
  c-->æ‹¿åˆ°äº†ç¬¬1ç¥¨
  ```

---

### äºŒ

- ç»™ä»–åŠ ä¸ªå»¶è¿Ÿè¯•è¯•: ä¸‰çº¿ç¨‹å¹¶è¡Œ,èµ„æºåˆ†é…åˆç†

  ```Java
    public void run() {
      while (true) {
        try {
          lock.lock(); // åŠ é”
          if (ticketNums > 0) {
            System.out.println(Thread.currentThread().getName() + "-->æ‹¿åˆ°äº†ç¬¬" + ticketNums-- + "ç¥¨");
          } else {
            break;
          }
        } finally {
          lock.unlock(); // è§£é”
          try {
            Thread.sleep(500);
          } catch (InterruptedException e) {
            e.printStackTrace();
          }
        }
      }
    }
  ```

  ```
  b-->æ‹¿åˆ°äº†ç¬¬10ç¥¨
  a-->æ‹¿åˆ°äº†ç¬¬9ç¥¨
  c-->æ‹¿åˆ°äº†ç¬¬8ç¥¨
  b-->æ‹¿åˆ°äº†ç¬¬7ç¥¨
  a-->æ‹¿åˆ°äº†ç¬¬6ç¥¨
  c-->æ‹¿åˆ°äº†ç¬¬5ç¥¨
  c-->æ‹¿åˆ°äº†ç¬¬4ç¥¨
  a-->æ‹¿åˆ°äº†ç¬¬3ç¥¨
  b-->æ‹¿åˆ°äº†ç¬¬2ç¥¨
  b-->æ‹¿åˆ°äº†ç¬¬1ç¥¨
  ```

---

### ä¸‰

- å†è¯•è¯•å»¶è¿Ÿä¹‹åè§£å¼€åŒæ­¥é”: å•çº¿æ‰§è¡Œ,èµ„æºåˆ†é…ä¸å¹³è¡¡

  ```Java
    public void run() {
      while (true) {
        try {
          lock.lock(); // åŠ é”
          if (ticketNums > 0) {
            System.out.println(Thread.currentThread().getName() + "-->æ‹¿åˆ°äº†ç¬¬" + ticketNums-- + "ç¥¨");
          } else {
            break;
          }
        } finally {
          try {
            Thread.sleep(500);
          } catch (InterruptedException e) {
            e.printStackTrace();
          }
          lock.unlock(); // è§£é”
        }
      }
    }
  ```

  ```
  a-->æ‹¿åˆ°äº†ç¬¬10ç¥¨
  a-->æ‹¿åˆ°äº†ç¬¬9ç¥¨
  c-->æ‹¿åˆ°äº†ç¬¬8ç¥¨
  c-->æ‹¿åˆ°äº†ç¬¬7ç¥¨
  c-->æ‹¿åˆ°äº†ç¬¬6ç¥¨
  c-->æ‹¿åˆ°äº†ç¬¬5ç¥¨
  c-->æ‹¿åˆ°äº†ç¬¬4ç¥¨
  c-->æ‹¿åˆ°äº†ç¬¬3ç¥¨
  c-->æ‹¿åˆ°äº†ç¬¬2ç¥¨
  b-->æ‹¿åˆ°äº†ç¬¬1ç¥¨
  ```

<a>![åˆ†å‰²çº¿](https://fastly.jsdelivr.net/gh/Weidows/Images/img/divider.png)</a>

## çº¿ç¨‹é€šä¿¡-wait-notify

```java
class Clerk {
  public int productNumber; // å”®è´§å‘˜æ‰‹ä¸­çš„å•†å“æ•°
}

public class ProducterAndCustomer {
  public static void main(String[] args) {
    Clerk clerk = new Clerk();

    new Thread(() -> {
      while (true) { //ä¸€ç›´ç”Ÿäº§
        synchronized (clerk) {
          try {
            if (clerk.productNumber == 0) {
              System.out.println("äº§å“ä¸º0, å¼€å§‹ç”Ÿäº§");
              while (clerk.productNumber < 5) {
                System.out.println("åº“å­˜: " + clerk.productNumber++);
                Thread.sleep(500);
              }
              clerk.notifyAll();
              //å•†å“æ•°ä¸ä¸º0æ—¶è®©clerkç­‰å¾…
            } else {
              // clerk.wait();
              clerk.wait();
            }
          } catch (InterruptedException e) {
            e.printStackTrace();
          }
        }
      }
    }, "ç”Ÿäº§è€…").start();

    new Thread(() -> {
      while (true) { //ä¸€ç›´æ¶ˆè´¹
        synchronized (clerk) {
          try {
            if (clerk.productNumber == 5) {
              System.out.println("äº§å“ä¸º5,å¼€å§‹æ¶ˆè´¹");
              while (clerk.productNumber > 0) {
                System.out.println("åº“å­˜: " + clerk.productNumber--);
                try {
                  Thread.sleep(500);
                } catch (InterruptedException e) {
                  e.printStackTrace();
                }
              }
              clerk.notifyAll();
            } else {
              // clerk.wait();
              clerk.wait();
            }
          } catch (InterruptedException e) {
            e.printStackTrace();
          }
        }
      }
    }, "æ¶ˆè´¹è€…").start();
  }
}
```

- ç»“æœ

  ```
  äº§å“ä¸º0, å¼€å§‹ç”Ÿäº§
  åº“å­˜: 0
  åº“å­˜: 1
  åº“å­˜: 2
  åº“å­˜: 3
  åº“å­˜: 4
  äº§å“ä¸º5,å¼€å§‹æ¶ˆè´¹
  åº“å­˜: 5
  åº“å­˜: 4
  åº“å­˜: 3
  åº“å­˜: 2
  åº“å­˜: 1
  äº§å“ä¸º0, å¼€å§‹ç”Ÿäº§
  åº“å­˜: 0
  ```

<a>![åˆ†å‰²çº¿](https://fastly.jsdelivr.net/gh/Weidows/Images/img/divider.png)</a>

## çº¿ç¨‹æ± 

- çº¿ç¨‹æ± çš„å‡ºç°æ˜¯ä¸ºäº†æ–¹ä¾¿å¤§é‡çš„çº¿ç¨‹åˆ›å»º,å›æ”¶å’Œç®¡ç†

- éœ€è¦äº†è§£ `ExecutorService` çº¿ç¨‹æ± æ¥å£;ä»¥åŠ `Executors` çº¿ç¨‹æ± å·¥å…·ç±».

  - corePoolSize: æ ¸å¿ƒæ± çš„å¤§å°

  - maximumPoolSize:æœ€å¤§çº¿ç¨‹æ•°

  - keepAliveTime: çº¿ç¨‹æ²¡æœ‰ä»»åŠ¡æ—¶æœ€å¤šä¿æŒå¤šé•¿æ—¶é—´åä¼šç»ˆæ­¢

  - void execute(Runnable command) :æ‰§è¡Œä»»åŠ¡/å‘½ä»¤,æ²¡æœ‰è¿”å›å€¼ï¼Œä¸€èˆ¬ç”¨æ¥æ‰§ Runnable

  - <T> Future<T> submit(Callable<T> task) :æ‰§è¡Œä»»åŠ¡,æœ‰è¿”å›å€¼ï¼Œä¸€èˆ¬ç”¨æ¥æ‰§è¡Œ Callable

- ä¾‹å­

  ```Java
  public class TestThreadPool {
    public static void main(String[] args) throws ExecutionException, InterruptedException {
      // 1.åˆ›å»ºæœåŠ¡ï¼Œåˆ›å»ºçº¿ç¨‹æ± 
      ExecutorService service = Executors.newFixedThreadPool(10);
      Runnable runnable = () -> {
        System.out.println(Thread.currentThread().getName() + " runnable");
      };
      Callable<String> callable = () -> {
        return Thread.currentThread().getName() + " callable";
      };

      // 2. æ‰§è¡Œ
      for (int i = 0; i < 5; i++) {
        service.execute(runnable);
        System.out.println(service.submit(callable).get());
      }

      // 3.å…³é—­è¿æ¥
      service.shutdown();
    }
  }
  /*
    pool-1-thread-1 runnable
    pool-1-thread-2 callable
    pool-1-thread-3 runnable
    pool-1-thread-4 callable
    pool-1-thread-5 runnable
    pool-1-thread-6 callable
    pool-1-thread-7 runnable
    pool-1-thread-8 callable
    pool-1-thread-9 runnable
    pool-1-thread-10 callable
  */
  ```
