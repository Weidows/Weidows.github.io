---
title: ğŸŒ­å›é¡¾ä¸€ä¸‹Javaå¤šçº¿ç¨‹~(è´°)
date: 2021-02-21 01:06:22
tags:
  - Java
  - å¤šçº¿ç¨‹
  - ç¬”è®°
cover: https://cdn.jsdelivr.net/gh/Weidows/Images/hpp/6UdHDGPQxBN4wV8.png
top_img:
---

<!--
 * @?: *********************************************************************
 * @Author: Weidows
 * @LastEditors: Weidows
 * @LastEditTime: 2021-02-24 17:17:20
 * @FilePath: \Weidowsd:\Game\Github\Blog-private\source\_posts\Java\å¤šçº¿ç¨‹\2.md
 * @Description:
 * @!: *********************************************************************
-->

- [çº¿ç¨‹çŠ¶æ€](#çº¿ç¨‹çŠ¶æ€)
- [çº¿ç¨‹ä¼˜å…ˆçº§](#çº¿ç¨‹ä¼˜å…ˆçº§)
- [å®ˆæŠ¤çº¿ç¨‹ daemon](#å®ˆæŠ¤çº¿ç¨‹-daemon)
- [çº¿ç¨‹åŒæ­¥](#çº¿ç¨‹åŒæ­¥)
  - [ä¹°ç¥¨](#ä¹°ç¥¨)
  - [é“¶è¡Œå–æ¬¾](#é“¶è¡Œå–æ¬¾)
    - [è¯•é”™](#è¯•é”™)
  - [List](#list)
- [æ­»é”](#æ­»é”)
  - [äº§ç”Ÿæ¡ä»¶](#äº§ç”Ÿæ¡ä»¶)
  - [è§£å†³æ–¹æ¡ˆ](#è§£å†³æ–¹æ¡ˆ)

![åˆ†å‰²çº¿](https://cdn.jsdelivr.net/gh/Weidows/Images/img/divider.png)

## çº¿ç¨‹çŠ¶æ€

<img src="https://cdn.jsdelivr.net/gh/Weidows/Images/hpp/20210221232406.png" alt="20210221232406" />

```java
public class TestState {
  public static void main(String[] args) throws InterruptedException {
    Thread thread = new Thread(() -> {
      for (int i = 0; i < 5; i++) {
        try {
          Thread.sleep(1000);
        } catch (InterruptedException e) {
          e.printStackTrace();
        }
      }
      System.out.println("///");
    });

    //è§‚å¯ŸçŠ¶æ€
    Thread.State state = thread.getState();
    System.out.println(state); //NEW

    //è§‚å¯Ÿåå¯åŠ¨
    thread.start(); //å¯åŠ¨çº¿ç¨‹
    state = thread.getState();
    System.out.println(); //Run

    while (state != Thread.State.TERMINATED) { //åªè¦çº¿ç¨‹ä¸åœæ­¢ï¼Œå°±ä¸€ç›´è¾“å‡ºçŠ¶æ€
      Thread.sleep(100);
      state = thread.getState(); //æ›´æ–°çº¿ç¨‹çŠ¶æ€
      System.out.println(state); //è¾“å‡ºçŠ¶æ€

      //thread.start();   æŠ¥é”™ï¼Œå› ä¸ºå·²ç»æ­»äº¡çš„çº¿ç¨‹ä¸èƒ½å†å¯åŠ¨
    }
  }
}
```

---

## çº¿ç¨‹ä¼˜å…ˆçº§

- çº¿ç¨‹çš„ä¼˜å…ˆçº§ç”¨æ•°å­—è¡¨ç¤ºï¼ŒèŒƒå›´ä» 1~10.

  - Thread.MIN_PRIORITY = 1;
  - Thread.MAX_PRIORITY = 10;
  - Thread.NORM_PRIORITY = 5;

- ä½¿ç”¨ä¸€ä¸‹æ–¹æ³•æ”¹å˜æˆ–è·å–ä¼˜å…ˆçº§

  - â€‹.getPriority()
  - .setPriority(int xxx)

- ä¸åšä¸¾ä¾‹äº†,è·³è¿‡.

---

## å®ˆæŠ¤çº¿ç¨‹ daemon

- çº¿ç¨‹åˆ†ä¸º`ç”¨æˆ·çº¿ç¨‹`å’Œ`å®ˆæŠ¤çº¿ç¨‹`,ç”¨æˆ·çº¿ç¨‹å¿…é¡»æ‰§è¡Œå®Œæ¯•ç¨‹åºæ‰ç»ˆæ­¢,è€Œå®ˆæŠ¤çº¿ç¨‹ä¸åšè¦æ±‚.

```Java
public class TestDaemon {
  public static void main(String[] args) {
    // ! ä¸Šå¸
    Runnable god = () -> {
      while (true) {
        System.out.println("ä¸Šå¸ä¿ä½‘ä½ ");
      }
    };
    // ! ä½ 
    Runnable you = () -> {
      for (int i = 0; i < 100; i++) {
        System.out.println("ä½ ä¸€ç”Ÿéƒ½å¼€å¿ƒçš„æ´»ç€");
      }
      System.out.println("GoodBye World");
    };

    Thread godThread = new Thread(god);
    godThread.setDaemon(true); //é»˜è®¤falseè¡¨ç¤ºæ˜¯ç”¨æˆ·çº¿ç¨‹ï¼Œæ­£å¸¸çš„çº¿ç¨‹éƒ½æ˜¯ç”¨æˆ·çº¿ç¨‹
    godThread.start();

    new Thread(you).start();
  }
}
```

- ç»“æœ: "you"çº¿ç¨‹ç»ˆæ­¢æ—¶ç¨‹åºå°±ç»“æŸäº†.

  ```
  ...
  ä¸Šå¸ä¿ä½‘ä½ 
  ä¸Šå¸ä¿ä½‘ä½ 
  ä½ ä¸€ç”Ÿéƒ½å¼€å¿ƒçš„æ´»ç€
  ä½ ä¸€ç”Ÿéƒ½å¼€å¿ƒçš„æ´»ç€
  ä½ ä¸€ç”Ÿéƒ½å¼€å¿ƒçš„æ´»ç€
  ä½ ä¸€ç”Ÿéƒ½å¼€å¿ƒçš„æ´»ç€
  ä¸Šå¸ä¿ä½‘ä½ 
  ä¸Šå¸ä¿ä½‘ä½ 
  ä¸Šå¸ä¿ä½‘ä½ 
  ä¸Šå¸ä¿ä½‘ä½ 
  ä¸Šå¸ä¿ä½‘ä½ 
  ä¸Šå¸ä¿ä½‘ä½ 
  ä¸Šå¸ä¿ä½‘ä½ 
  ä¸Šå¸ä¿ä½‘ä½ 
  ä¸Šå¸ä¿ä½‘ä½ 
  ä¸Šå¸ä¿ä½‘ä½ 
  ä¸Šå¸ä¿ä½‘ä½ 
  ä¸Šå¸ä¿ä½‘ä½ 
  GoodBye World
  ä¸Šå¸ä¿ä½‘ä½ 
  ä¸Šå¸ä¿ä½‘ä½ 
  ```

![åˆ†å‰²çº¿](https://cdn.jsdelivr.net/gh/Weidows/Images/img/divider.png)

## çº¿ç¨‹åŒæ­¥

- å¤šä¸ªçº¿ç¨‹æ“ä½œåŒä¸€èµ„æºæ—¶ä¼šæœ‰é—®é¢˜å‡ºç°,ç”¨ `synchronized` åŒæ­¥.

### ä¹°ç¥¨

```Java
public class Ticket implements Runnable {
  private int ticketNums = 10; //ç¥¨æ•°
  boolean flag = true; //å¤–éƒ¨åœæ­¢æ–¹æ³•

  @Override
  public void run() {
    while (flag) {
      buy();
    }
  }

  public synchronized void buy() {
    //åˆ¤æ–­æ˜¯å¦æœ‰ç¥¨
    if (ticketNums <= 0) {
      flag = false;
      return;
    }
    //æ¨¡æ‹Ÿå»¶æ—¶
    try {
      Thread.sleep(200);
    } catch (InterruptedException e) {
      e.printStackTrace();
    }
    System.out.println(Thread.currentThread().getName() + "-->å¾—åˆ°å€’æ•°ç¬¬" + ticketNums-- + "ç¥¨");
  }

  public static void main(String[] args) {
    Ticket ticket = new Ticket();

    new Thread(ticket, "å°æ˜").start();
    new Thread(ticket, "è€å¸ˆ").start();
    new Thread(ticket, "é»„ç‰›").start();
  }
}
```

- ç»“æœ

  ```
  å°æ˜-->å¾—åˆ°å€’æ•°ç¬¬10ç¥¨
  å°æ˜-->å¾—åˆ°å€’æ•°ç¬¬9ç¥¨
  å°æ˜-->å¾—åˆ°å€’æ•°ç¬¬8ç¥¨
  å°æ˜-->å¾—åˆ°å€’æ•°ç¬¬7ç¥¨
  å°æ˜-->å¾—åˆ°å€’æ•°ç¬¬6ç¥¨
  å°æ˜-->å¾—åˆ°å€’æ•°ç¬¬5ç¥¨
  å°æ˜-->å¾—åˆ°å€’æ•°ç¬¬4ç¥¨
  å°æ˜-->å¾—åˆ°å€’æ•°ç¬¬3ç¥¨
  å°æ˜-->å¾—åˆ°å€’æ•°ç¬¬2ç¥¨
  å°æ˜-->å¾—åˆ°å€’æ•°ç¬¬1ç¥¨
  ```

---

### é“¶è¡Œå–æ¬¾

```Java
import java.math.BigDecimal;

public class Bank {
  public static void main(String[] args) {
    Account account = new Account(new BigDecimal(100), "æˆ‘çš„è´¦æˆ·");

    DrawingChannel a = new DrawingChannel(account, new BigDecimal(50), "A");
    DrawingChannel b = new DrawingChannel(account, new BigDecimal(100), "B");

    a.start();
    b.start();
  }
}

//è´¦æˆ·
class Account {
  BigDecimal balance;//ä½™é¢
  final String name; //å¡å

  public Account(BigDecimal balance, String name) {
    this.balance = balance;
    this.name = name;
  }
}

/**
 * é“¶è¡Œï¼šæ¨¡æ‹Ÿå–æ¬¾
 * * è¿™é‡Œä¹‹æ‰€ä»¥æ²¡ç”¨å®ç°Runnableæ¥å£çš„æ–¹å¼æ˜¯ä¸ºäº†è°ƒç”¨Threadç±»ä¸­ä¸€äº›æ–¹æ³•
 */
class DrawingChannel extends Thread {
  final Account account; //è´¦æˆ·
  BigDecimal drawingMoney; //å–äº†å¤šå°‘é’±
  BigDecimal nowMoney; //ç°åœ¨æ‰‹é‡Œæœ‰å¤šå°‘é’±

  public DrawingChannel(Account account, BigDecimal drawingMoney, String name) {
    super(name);
    this.account = account;
    this.drawingMoney = drawingMoney;
    this.nowMoney = new BigDecimal(0);
  }

  @Override
  public void run() {
    synchronized (account) {
      //åˆ¤æ–­æœ‰æ²¡æœ‰é’±
      if (account.balance.compareTo(drawingMoney) < 0) {
        System.out.println(account.name + "é’±ä¸å¤Ÿ" + drawingMoney + "," + this.getName() + "æ— æ³•å–èµ°");
        return;
      }

      // æ”¾å¤§é”™è¯¯
      try {
        sleep(1000);
      } catch (InterruptedException e) {
        e.printStackTrace();
      }
      draw();
    }
  }

  private void draw() {
    //å¡å†…ä½™é¢ = ä½™é¢ - å–çš„é’±
    account.balance = account.balance.subtract(drawingMoney);
    System.out.println(this.getName() + "å–èµ°" + drawingMoney);

    //æ‰‹é‡Œçš„é’±
    nowMoney = nowMoney.add(drawingMoney);

    System.out.println(account.name + "ä½™é¢ä¸ºï¼š" + account.balance);
    System.out.println(this.getName() + "æ‰‹é‡Œçš„é’±ï¼š" + nowMoney);
  }
}
```

- é¢„æœŸç»“æœ

  ```
  Aå–èµ°50
  æˆ‘çš„è´¦æˆ·ä½™é¢ä¸ºï¼š50
  Aæ‰‹é‡Œçš„é’±ï¼š50
  æˆ‘çš„è´¦æˆ·é’±ä¸å¤Ÿ100,Bæ— æ³•å–èµ°
  ```

---

#### è¯•é”™

- ç†Ÿç»ƒä½¿ç”¨.sleep()è¯•é”™

  - è¯•é”™å‰

    ```
    æˆ‘çš„è´¦æˆ·é’±ä¸å¤Ÿ100,Bæ— æ³•å–èµ°
    æˆ‘çš„è´¦æˆ·ä½™é¢ä¸ºï¼š50
    Aæ‰‹é‡Œçš„é’±ï¼š50
    ```

  ***

  - è¯•é”™å

    ```
    B å–èµ° 100
    A å–èµ° 50
    æˆ‘çš„è´¦æˆ·ä½™é¢ä¸ºï¼š50
    æˆ‘çš„è´¦æˆ·ä½™é¢ä¸ºï¼š50
    A æ‰‹é‡Œçš„é’±ï¼š50
    B æ‰‹é‡Œçš„é’±ï¼š100
    ```

---

### List

- å¤šä¸ªçº¿ç¨‹åŒæ—¶æ“ä½œ List å¯¹è±¡æ—¶å¯èƒ½ä¼šå­˜åœ¨è¦†å†™(çº¿ç¨‹ä¸å®‰å…¨)

- éçº¿ç¨‹åŒæ­¥

  ```Java
  import java.util.ArrayList;
  import java.util.List;

  public class TestList {
    public static void main(String[] args) throws InterruptedException {
      List<String> list = new ArrayList<String>();

      for (int i = 0; i < 10000; i++) {
        new Thread(() -> {
          list.add(Thread.currentThread().getName());
        }).start();
      }
      Thread.sleep(3000); // å»¶æ—¶,ä¸ºäº†ç­‰ä¸Šé¢æ‰§è¡Œå®Œæ¯•
      System.out.println(list.size());//è¾“å‡ºï¼š9992
    }
  }
  ```

  ***

- çº¿ç¨‹åŒæ­¥

  ```Java
  import java.util.ArrayList;
  import java.util.List;

  public class TestList {
    public static void main(String[] args) throws InterruptedException {
      List<String> list = new ArrayList<String>();

      for (int i = 0; i < 10000; i++) {
        new Thread(() -> {
          synchronized (list) {
            list.add(Thread.currentThread().getName());
          }
        }).start();
      }
      Thread.sleep(3000); // å»¶æ—¶,ä¸ºäº†ç­‰ä¸Šé¢æ‰§è¡Œå®Œæ¯•
      System.out.println(list.size());//è¾“å‡ºï¼š10000
    }
  }
  ```

  ***

- çº¿ç¨‹å®‰å…¨ List

  ```Java
  import java.util.List;
  import java.util.concurrent.CopyOnWriteArrayList;

  public class JUC {
    public static void main(String[] args) {
      List<String> list = new CopyOnWriteArrayList<String>();

      for (int i = 0; i < 10000; i++) {
        new Thread(() -> {
          list.add(Thread.currentThread().getName());
        }).start();
      }

      try {
        Thread.sleep(3000);
      } catch (InterruptedException e) {
        e.printStackTrace();
      }

      System.out.println(list.size());//è¾“å‡ºï¼š10000
    }
  }
  ```

![åˆ†å‰²çº¿](https://cdn.jsdelivr.net/gh/Weidows/Images/img/divider.png)

## æ­»é”

- ä¸¤çº¿ç¨‹åœ¨å„è‡ªæ‹¥æœ‰ä¸€ä¸ªå¯¹è±¡çš„é”æ—¶éƒ½ç­‰å¾…å¯¹æ–¹çº¿ç¨‹é‡Šæ”¾å¯¹è±¡çš„é”

- ä¹Ÿæœ‰å¯èƒ½å¾ˆå¤šçº¿ç¨‹äº§ç”Ÿç¯å½¢æ­»é”æˆ–è€…æ›´å¤æ‚çš„.

- å¦‚ä¸‹ä¾‹å­å°±ä¼šäº§ç”Ÿæ­»é”

  ```Java
  //æ­»é”ï¼šå¤šä¸ªçº¿ç¨‹äº’ç›¸æŠ±ç€å¯¹æ–¹éœ€è¦çš„èµ„æº
  public class DeadLock {
    public static void main(String[] args) {
      Makeup m1 = new Makeup(0, "å°é»‘");
      Makeup m2 = new Makeup(1, "å°ç™½");

      m1.start();
      m2.start();
    }
  }

  //å£çº¢
  class Lipstick {
  }

  //é•œå­
  class Mirror {
  }

  //åŒ–å¦†
  class Makeup extends Thread {
    //éœ€è¦çš„èµ„æºåªæœ‰ä¸€ä»½ï¼Œç”¨staticæ¥ä¿è¯åªæœ‰ä¸€ä»½
    static final Lipstick lipstick = new Lipstick();
    static final Mirror mirror = new Mirror();

    int choice; //é€‰æ‹©
    String name; //ä½¿ç”¨åŒ–å¦†å“çš„äºº

    public Makeup(int choice, String name) {
      this.choice = choice;
      this.name = name;
    }

    @Override
    public void run() {
      //åŒ–å¦†
      try {
        makeup();
      } catch (InterruptedException e) {
        e.printStackTrace();
      }
    }

    //åŒ–å¦†ï¼Œäº’ç›¸æŒæœ‰å¯¹æ–¹çš„é”ï¼Œå°±æ˜¯éœ€è¦æ‹¿åˆ°å¯¹æ–¹çš„èµ„æº
    private void makeup() throws InterruptedException {
      if (choice == 0) {
        synchronized (lipstick) { //è·å¾—å£çº¢çš„é”
          System.out.println(this.name + "è·å¾—å£çº¢çš„é”");
          Thread.sleep(1000);

          synchronized (mirror) { //ä¸€ç§’é’Ÿåæƒ³è·å¾—é•œå­çš„é”
            System.out.println(this.name + "è·å¾—é•œå­çš„é”");
          }
        }
      } else {
        synchronized (mirror) { //è·å¾—é•œå­çš„é”
          System.out.println(this.name + "è·å¾—é•œå­çš„é”");
          Thread.sleep(2000);
          synchronized (lipstick) { //ä¸¤ç§’é’Ÿåæƒ³è·å¾—å£çº¢çš„é”
            System.out.println(this.name + "è·å¾—å£çº¢çš„é”");
          }
        }
      }
    }
  }
  ```

---

### äº§ç”Ÿæ¡ä»¶

- å››ä¸ªå¿…è¦æ¡ä»¶:

  1. äº’æ–¥æ¡ä»¶ï¼šä¸€ä¸ªèµ„æºæ¯æ¬¡åªèƒ½è¢«ä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨ã€‚
  2. è¯·æ±‚ä¸ä¿æŒæ¡ä»¶ï¼šä¸€ä¸ªè¿›ç¨‹å› è¯·æ±‚èµ„æºè€Œé˜»å¡æ—¶ï¼Œå¯¹å·²è·å¾—çš„èµ„æºä¿æŒä¸æ”¾ã€‚
  3. ä¸å‰¥å¤ºæ¡ä»¶ï¼šè¿›ç¨‹å·²è·å¾—çš„èµ„æºï¼Œåœ¨æœªä½¿ç”¨å®Œä¹‹å‰ä¸èƒ½å¼ºè¡Œå‰¥å¤ºã€‚
  4. å¾ªç¯ç­‰å¾…æ¡ä»¶ï¼šè‹¥å¹²è¿›ç¨‹ä¹‹é—´å½¢æˆä¸€ç§å¤´å°¾ç›¸æ¥çš„å¾ªç¯ç­‰å¾…èµ„æºå…³ç³»ã€‚

---

### è§£å†³æ–¹æ¡ˆ

- ä½¿ç”¨å®ŒåŒæ­¥å¯¹è±¡åç«‹å³é‡Šæ”¾

  - æ¯”å¦‚ä¸Šé¢çš„ä¾‹å­ä¸­ä½¿ç”¨å®Œ`å£çº¢`æˆ–è€…`é•œå­`åæœªé‡Šæ”¾,å†å»è·å–å¦ä¸€ä¸ªå¯¹è±¡çš„é”,å°±ä¼šäº§ç”Ÿæ­»é”äº†
  - ä¿®æ”¹: æŠŠ makeup æ”¹ä¸ºå¦‚ä¸‹

  ```Java
  private void makeup() throws InterruptedException {
    if (choice == 0) {
      synchronized (lipstick) { // è·å¾—å£çº¢çš„é”
        System.out.println(this.name + "è·å¾—å£çº¢çš„é”");
        Thread.sleep(1000);
      }
      synchronized (mirror) { // ä¸€ç§’é’Ÿåæƒ³è·å¾—é•œå­çš„é”
        System.out.println(this.name + "è·å¾—é•œå­çš„é”");
      }
    } else {
      synchronized (mirror) { // è·å¾—é•œå­çš„é”
        System.out.println(this.name + "è·å¾—é•œå­çš„é”");
        Thread.sleep(2000);
      }
      synchronized (lipstick) { // ä¸¤ç§’é’Ÿåæƒ³è·å¾—å£çº¢çš„é”
        System.out.println(this.name + "è·å¾—å£çº¢çš„é”");
      }
    }
  }
  ```
