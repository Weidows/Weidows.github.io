---
title: ğŸŒ­å›é¡¾ä¸€ä¸‹Javaå¤šçº¿ç¨‹~(å)
date: 2021-02-24 17:14:17
categories:
  - Java
  - å¤šçº¿ç¨‹
tags:
  - Java
  - å¤šçº¿ç¨‹
  - ç¬”è®°
cover: https://cdn.jsdelivr.net/gh/Weidows/Images/hpp/6UdHDGPQxBN4wV8.png
top_img:
---

<!--
 * @?: *********************************************************************
 * @Author: Weidows
 * @LastEditors: Weidows
 * @LastEditTime: 2021-03-19 00:14:47
 * @FilePath: \Weidowsd:\Game\Github\Blog-private\source\_posts\Java\å¤šçº¿ç¨‹\3.md
 * @Description:
 * @!: *********************************************************************
-->

- [å¯é‡å…¥é” ReentrantLock](#å¯é‡å…¥é”-reentrantlock)
- [å¤šçº¿ç¨‹ä¸å¾ªç¯æ§åˆ¶](#å¤šçº¿ç¨‹ä¸å¾ªç¯æ§åˆ¶)
- [å»¶è¿Ÿå¯¹å¤šçº¿ç¨‹çš„å½±å“](#å»¶è¿Ÿå¯¹å¤šçº¿ç¨‹çš„å½±å“)
  - [ä¸€](#ä¸€)
  - [äºŒ](#äºŒ)
  - [ä¸‰](#ä¸‰)
- [çº¿ç¨‹é€šä¿¡](#çº¿ç¨‹é€šä¿¡)
- [çº¿ç¨‹æ± ](#çº¿ç¨‹æ± )
- [Over](#over)

![åˆ†å‰²çº¿](https://cdn.jsdelivr.net/gh/Weidows/Images/img/divider.png)

# å¯é‡å…¥é” ReentrantLock

- ReentrantLock ç±»å®ç°äº† java.util.concurrent.locks.Lock æ¥å£

- ä¸ synchronized åŒºåˆ«:

  - ReentrantLock æ˜¯æ˜¾å¼åŠ è§£é”,å®ƒåªèƒ½é”ä»£ç å—
  - æ€§èƒ½æ¯” synchronized å¥½

- ä½¿ç”¨ä¼˜å…ˆåº¦

  - Lock >åŒæ­¥ä»£ç å—(å·²ç»è¿›å…¥äº†æ–¹æ³•ä½“ï¼Œåˆ†é…äº†ç›¸åº”èµ„æº) >åŒæ­¥æ–¹æ³•(åœ¨æ–¹æ³•ä½“ä¹‹å¤–)

- æ³¨æ„ç‚¹: åŠ è§£é”æœ€å¥½è¦åœ¨ try-finally é‡Œ

  ```Java
  try {
    lock.lock(); // åŠ é”
  } finally {
    lock.unlock(); // è§£é”
  }
  ```

- ä¾‹å­

  ```Java
  import java.util.concurrent.locks.ReentrantLock;

  public class TestLock implements Runnable {
    int ticketNums = 10;
    private final ReentrantLock lock = new ReentrantLock(); // å®šä¹‰Locké”

    @Override
    public void run() {
      while (true) {
        try {
          lock.lock(); // åŠ é”
          if (ticketNums > 0) {
            System.out.println(Thread.currentThread().getName() + "-->æ‹¿åˆ°äº†ç¬¬" + ticketNums-- + "ç¥¨");
          } else {
            break;
          }
        } finally {
          lock.unlock(); // è§£é”
          try {
            Thread.sleep(500);
          } catch (InterruptedException e) {
            e.printStackTrace();
          }
        }
      }
    }

    public static void main(String[] args) {
      TestLock testLock = new TestLock();

      new Thread(testLock, "a").start();
      new Thread(testLock, "b").start();
      new Thread(testLock, "c").start();
    }
  }
  ```

- ç»“æœ

  ```
  a-->æ‹¿åˆ°äº†ç¬¬10ç¥¨
  c-->æ‹¿åˆ°äº†ç¬¬9ç¥¨
  b-->æ‹¿åˆ°äº†ç¬¬8ç¥¨
  b-->æ‹¿åˆ°äº†ç¬¬7ç¥¨
  c-->æ‹¿åˆ°äº†ç¬¬6ç¥¨
  a-->æ‹¿åˆ°äº†ç¬¬5ç¥¨
  b-->æ‹¿åˆ°äº†ç¬¬4ç¥¨
  a-->æ‹¿åˆ°äº†ç¬¬3ç¥¨
  c-->æ‹¿åˆ°äº†ç¬¬2ç¥¨
  c-->æ‹¿åˆ°äº†ç¬¬1ç¥¨
  ```

![åˆ†å‰²çº¿](https://cdn.jsdelivr.net/gh/Weidows/Images/img/divider.png)

# å¤šçº¿ç¨‹ä¸å¾ªç¯æ§åˆ¶

```Java
import java.util.concurrent.locks.ReentrantLock;

public class TestLock implements Runnable {
  int ticketNums = 10;
  private final ReentrantLock lock = new ReentrantLock(); // å®šä¹‰Locké”

  @Override
  public void run() {
    while (ticketNums > 0) {
      try {
        lock.lock(); // åŠ é”
        Thread.sleep(500);
        System.out.println(Thread.currentThread().getName() + "-->æ‹¿åˆ°äº†ç¬¬" + ticketNums-- + "ç¥¨");
      } catch (InterruptedException e) {
        e.printStackTrace();
      } finally {
        lock.unlock(); // è§£é”
      }
    }
  }

  public static void main(String[] args) {
    TestLock testLock = new TestLock();

    new Thread(testLock, "a").start();
    new Thread(testLock, "b").start();
    new Thread(testLock, "c").start();
  }
}
```

- ä¸Šé¢ä»£ç  while å¾ªç¯ä¼šå­˜åœ¨åˆ¤æ–­å¤±è¯¯

  ```
  c-->æ‹¿åˆ°äº†ç¬¬10ç¥¨
  c-->æ‹¿åˆ°äº†ç¬¬9ç¥¨
  c-->æ‹¿åˆ°äº†ç¬¬8ç¥¨
  c-->æ‹¿åˆ°äº†ç¬¬7ç¥¨
  c-->æ‹¿åˆ°äº†ç¬¬6ç¥¨
  c-->æ‹¿åˆ°äº†ç¬¬5ç¥¨
  c-->æ‹¿åˆ°äº†ç¬¬4ç¥¨
  c-->æ‹¿åˆ°äº†ç¬¬3ç¥¨
  c-->æ‹¿åˆ°äº†ç¬¬2ç¥¨
  c-->æ‹¿åˆ°äº†ç¬¬1ç¥¨
  b-->æ‹¿åˆ°äº†ç¬¬0ç¥¨
  a-->æ‹¿åˆ°äº†ç¬¬-1ç¥¨
  ```

- ticketNums åœ¨åˆ¤æ–­ä¹‹åè¢«å¤šæ¬¡ä¿®æ”¹

  - ä¸Šé¢ 10~1 æ¬¡éƒ½æ˜¯ c çº¿ç¨‹æ‰§è¡Œçš„,å®ƒæ‰§è¡Œåè½®åˆ° b å’Œ a
  - ä½†æ˜¯ b ä¸ a çº¿ç¨‹å®é™…ä¸Šæ˜¯åœ¨`ticketNums=10`æ—¶è¿›å…¥çš„å¾ªç¯,æ‰€ä»¥ä¼šå¯¼è‡´`-1`å‡ºç°

- æ‰€ä»¥å»ºè®®æ˜¯:
  - é‡åˆ°å¤šçº¿ç¨‹å¾ªç¯æ§åˆ¶æ—¶,ç›´æ¥`while(true)`,ç„¶ååœ¨å†…éƒ¨ç”¨`if`

---

# å»¶è¿Ÿå¯¹å¤šçº¿ç¨‹çš„å½±å“

> ä¸‹é¢ä¸‰ä¸ªä¾‹å­æ•°æ®éƒ½æ²¡é”™,å…³é”®çœ‹å¹¶å‘æ•°é‡å’Œæ‰§è¡Œæ—¶é—´

## ä¸€

- ç¬é—´æ‰§è¡Œå®Œ,èµ„æºè¢«å•ä¸€çº¿ç¨‹å…¨éƒ¨æŠ¢å 

  ```Java
  import java.util.concurrent.locks.ReentrantLock;

  public class TestLock implements Runnable {
    int ticketNums = 10;
    private final ReentrantLock lock = new ReentrantLock(); // å®šä¹‰Locké”

    @Override
    public void run() {
      while (true) {
        try {
          lock.lock(); // åŠ é”
          if (ticketNums > 0) {
            System.out.println(Thread.currentThread().getName() + "-->æ‹¿åˆ°äº†ç¬¬" + ticketNums-- + "ç¥¨");
          } else {
            break;
          }
        } finally {
          lock.unlock(); // è§£é”
          // try {
          //   Thread.sleep(500);
          // } catch (InterruptedException e) {
          //   e.printStackTrace();
          // }
        }
      }
    }

    public static void main(String[] args) {
      TestLock testLock = new TestLock();

      new Thread(testLock, "a").start();
      new Thread(testLock, "b").start();
      new Thread(testLock, "c").start();
    }
  }
  ```

  ```
  c-->æ‹¿åˆ°äº†ç¬¬9ç¥¨
  c-->æ‹¿åˆ°äº†ç¬¬8ç¥¨
  c-->æ‹¿åˆ°äº†ç¬¬7ç¥¨
  c-->æ‹¿åˆ°äº†ç¬¬6ç¥¨
  c-->æ‹¿åˆ°äº†ç¬¬5ç¥¨
  c-->æ‹¿åˆ°äº†ç¬¬4ç¥¨
  c-->æ‹¿åˆ°äº†ç¬¬3ç¥¨
  c-->æ‹¿åˆ°äº†ç¬¬2ç¥¨
  c-->æ‹¿åˆ°äº†ç¬¬1ç¥¨
  ```

  ***

## äºŒ

- ç»™ä»–åŠ ä¸ªå»¶è¿Ÿè¯•è¯•:

  - ä¸‰çº¿ç¨‹å¹¶å‘,èµ„æºåˆ†é…åˆç†

  ```Java
    public void run() {
      while (true) {
        try {
          lock.lock(); // åŠ é”
          if (ticketNums > 0) {
            System.out.println(Thread.currentThread().getName() + "-->æ‹¿åˆ°äº†ç¬¬" + ticketNums-- + "ç¥¨");
          } else {
            break;
          }
        } finally {
          lock.unlock(); // è§£é”
          try {
            Thread.sleep(500);
          } catch (InterruptedException e) {
            e.printStackTrace();
          }
        }
      }
    }
  ```

  ```
  b-->æ‹¿åˆ°äº†ç¬¬10ç¥¨
  a-->æ‹¿åˆ°äº†ç¬¬9ç¥¨
  c-->æ‹¿åˆ°äº†ç¬¬8ç¥¨
  b-->æ‹¿åˆ°äº†ç¬¬7ç¥¨
  a-->æ‹¿åˆ°äº†ç¬¬6ç¥¨
  c-->æ‹¿åˆ°äº†ç¬¬5ç¥¨
  c-->æ‹¿åˆ°äº†ç¬¬4ç¥¨
  a-->æ‹¿åˆ°äº†ç¬¬3ç¥¨
  b-->æ‹¿åˆ°äº†ç¬¬2ç¥¨
  b-->æ‹¿åˆ°äº†ç¬¬1ç¥¨
  ```

  ***

## ä¸‰

- å†è¯•è¯•å»¶è¿Ÿä¹‹åè§£å¼€åŒæ­¥é”

  - å•çº¿æ‰§è¡Œ,èµ„æºåˆ†é…ä¸å¹³è¡¡

  ```Java
    public void run() {
      while (true) {
        try {
          lock.lock(); // åŠ é”
          if (ticketNums > 0) {
            System.out.println(Thread.currentThread().getName() + "-->æ‹¿åˆ°äº†ç¬¬" + ticketNums-- + "ç¥¨");
          } else {
            break;
          }
        } finally {
          try {
            Thread.sleep(500);
          } catch (InterruptedException e) {
            e.printStackTrace();
          }
          lock.unlock(); // è§£é”
        }
      }
    }
  ```

  ```
  a-->æ‹¿åˆ°äº†ç¬¬10ç¥¨
  a-->æ‹¿åˆ°äº†ç¬¬9ç¥¨
  c-->æ‹¿åˆ°äº†ç¬¬8ç¥¨
  c-->æ‹¿åˆ°äº†ç¬¬7ç¥¨
  c-->æ‹¿åˆ°äº†ç¬¬6ç¥¨
  c-->æ‹¿åˆ°äº†ç¬¬5ç¥¨
  c-->æ‹¿åˆ°äº†ç¬¬4ç¥¨
  c-->æ‹¿åˆ°äº†ç¬¬3ç¥¨
  c-->æ‹¿åˆ°äº†ç¬¬2ç¥¨
  b-->æ‹¿åˆ°äº†ç¬¬1ç¥¨
  ```

![åˆ†å‰²çº¿](https://cdn.jsdelivr.net/gh/Weidows/Images/img/divider.png)

# çº¿ç¨‹é€šä¿¡

> [ç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…æ¨¡å‹](https://github.com/Weidows/Weidows/blob/master/Java/src/main/java/twenty/november/thread/producer_and_customer/Test.java)

---

# çº¿ç¨‹æ± 

- çº¿ç¨‹æ± çš„å‡ºç°æ˜¯ä¸ºäº†æ–¹ä¾¿å¤§é‡çš„çº¿ç¨‹åˆ›å»º,å›æ”¶å’Œç®¡ç†

- éœ€è¦äº†è§£ `ExecutorService` çº¿ç¨‹æ± æ¥å£;ä»¥åŠ `Executors` çº¿ç¨‹æ± å·¥å…·ç±».

  - corePoolSize: æ ¸å¿ƒæ± çš„å¤§å°

  - maximumPoolSize:æœ€å¤§çº¿ç¨‹æ•°

  - keepAliveTime: çº¿ç¨‹æ²¡æœ‰ä»»åŠ¡æ—¶æœ€å¤šä¿æŒå¤šé•¿æ—¶é—´åä¼šç»ˆæ­¢

  - void execute(Runnable command) :æ‰§è¡Œä»»åŠ¡/å‘½ä»¤,æ²¡æœ‰è¿”å›å€¼ï¼Œä¸€èˆ¬ç”¨æ¥æ‰§ Runnable

  - <T> Future<T> submit(Callable<T> task) :æ‰§è¡Œä»»åŠ¡,æœ‰è¿”å›å€¼ï¼Œä¸€èˆ¬ç”¨æ¥æ‰§è¡Œ Callable

- ä¾‹å­

  ```Java
  import java.util.concurrent.Callable;
  import java.util.concurrent.ExecutionException;
  import java.util.concurrent.ExecutorService;
  import java.util.concurrent.Executors;

  public class TestThreadPool {
    public static void main(String[] args) {
      // 1.åˆ›å»ºæœåŠ¡ï¼Œåˆ›å»ºçº¿ç¨‹æ± 
      ExecutorService service = Executors.newFixedThreadPool(10); // å‚æ•°ä¸ºçº¿ç¨‹æ± å¤§å°
      Runnable myThread = () -> {
        System.out.println(Thread.currentThread().getName());
      };
      Callable<String> myThread2 = () -> {
        return "Running in " + Thread.currentThread().getName();
      };

      // æ‰§è¡Œ:å‰äº”ä¸ªæ˜¯Runnable,åäº”ä¸ªæ˜¯Callable
      service.execute(myThread);
      service.execute(myThread);
      service.execute(myThread);
      service.execute(myThread);
      service.execute(myThread);
      try {
        System.out.println(service.submit(myThread2).get());
        System.out.println(service.submit(myThread2).get());
        System.out.println(service.submit(myThread2).get());
        System.out.println(service.submit(myThread2).get());
        System.out.println(service.submit(myThread2).get());
      } catch (InterruptedException | ExecutionException e) {
        e.printStackTrace();
      }

      // 2.å…³é—­è¿æ¥
      service.shutdown();
    }
  }

  // class MyThread implements Runnable {
  //   @Override
  //   public void run() {
  //     System.out.println(Thread.currentThread().getName());
  //   }
  // }

  // class MyThread2 implements Callable {
  //   @Override
  //   public Object call() throws Exception {
  //     return "Running in " + Thread.currentThread().getName();
  //   }
  // }
  ```

- ç»“æœ

  ```
  pool-1-thread-2
  Running in pool-1-thread-6
  pool-1-thread-4
  pool-1-thread-5
  pool-1-thread-3
  pool-1-thread-1
  Running in pool-1-thread-7
  Running in pool-1-thread-8
  Running in pool-1-thread-9
  Running in pool-1-thread-10
  ```

![åˆ†å‰²çº¿](https://cdn.jsdelivr.net/gh/Weidows/Images/img/divider.png)

# Over
